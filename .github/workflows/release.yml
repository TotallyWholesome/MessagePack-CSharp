name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v3.1.4
  workflow_dispatch:  # Allows manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 3.1.4)'
        required: true
        default: '3.1.4'

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for versioning
    
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Get version from tag or input
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Restore dependencies
      run: dotnet restore MessagePack-CSharp.sln
    
    - name: Build solution
      run: dotnet build MessagePack-CSharp.sln --configuration ${{ env.CONFIGURATION }} --no-restore
    
    - name: Run tests
      run: dotnet test MessagePack-CSharp.sln --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      continue-on-error: true  # Don't fail release if tests fail
    
    - name: Pack NuGet packages
      run: |
        dotnet pack src/MessagePack/MessagePack.csproj \
          --configuration ${{ env.CONFIGURATION }} \
          --no-build \
          --output ./artifacts/nuget \
          /p:Version=${{ steps.get_version.outputs.VERSION }} \
          /p:PackageVersion=${{ steps.get_version.outputs.VERSION }}
        
        dotnet pack src/MessagePack.Annotations/MessagePack.Annotations.csproj \
          --configuration ${{ env.CONFIGURATION }} \
          --no-build \
          --output ./artifacts/nuget \
          /p:Version=${{ steps.get_version.outputs.VERSION }}
        
        dotnet pack src/MessagePack.AspNetCoreMvcFormatter/MessagePack.AspNetCoreMvcFormatter.csproj \
          --configuration ${{ env.CONFIGURATION }} \
          --no-build \
          --output ./artifacts/nuget \
          /p:Version=${{ steps.get_version.outputs.VERSION }}
    
    - name: Copy DLL artifacts
      run: |
        mkdir -p ./artifacts/dlls
        cp -r bin/MessagePack/${{ env.CONFIGURATION }}/net9.0/* ./artifacts/dlls/ || true
        cp -r bin/MessagePack.Annotations/${{ env.CONFIGURATION }}/net9.0/* ./artifacts/dlls/ || true
        cp -r bin/MessagePack.AspNetCoreMvcFormatter/${{ env.CONFIGURATION }}/net9.0/* ./artifacts/dlls/ || true
    
    - name: Create DLL archive
      run: |
        cd ./artifacts/dlls
        zip -r ../MessagePack-CSharp-${{ steps.get_version.outputs.VERSION }}-net9.0.zip .
        cd ../..
    
    - name: List artifacts
      run: |
        echo "NuGet packages:"
        ls -lh ./artifacts/nuget/
        echo "DLL archive:"
        ls -lh ./artifacts/*.zip
    
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', github.event.inputs.version) || github.ref }}
        release_name: MessagePack for C# (.NET 9) v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## MessagePack for C# - .NET 9 Release
          
          ### What's New in this .NET 9 Build
          - ?? Full .NET 9 compatibility with C# 12 support
          - ? Performance optimizations for modern .NET runtime
          - ?? ASP.NET Core 9 integration
          - ? Zero warnings, clean codebase
          - ?? Optimized for Resonite and modern game engines
          
          ### Installation
          
          **NuGet Package:**
          ```
          dotnet add package MessagePack --version ${{ steps.get_version.outputs.VERSION }}
          ```
          
          **Direct DLL:**
          Download the attached `MessagePack-CSharp-${{ steps.get_version.outputs.VERSION }}-net9.0.zip` file.
          
          ### Package Contents
          - `MessagePack.dll` - Core serialization library
          - `MessagePack.Annotations.dll` - Attribute definitions
          - `MessagePack.AspNetCoreMvcFormatter.dll` - ASP.NET Core integration
          
          ### Requirements
          - .NET 9.0 or later
          - C# 12 support
          
          For full documentation, see the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
        draft: false
        prerelease: false
    
    - name: Upload DLL archive to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/MessagePack-CSharp-${{ steps.get_version.outputs.VERSION }}-net9.0.zip
        asset_name: MessagePack-CSharp-${{ steps.get_version.outputs.VERSION }}-net9.0.zip
        asset_content_type: application/zip
    
    - name: Upload NuGet packages to release
      run: |
        for file in ./artifacts/nuget/*.nupkg; do
          filename=$(basename "$file")
          echo "Uploading $filename"
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$file" \
            "${{ steps.create_release.outputs.upload_url }}?name=$filename"
        done
    
    - name: Publish to NuGet.org (optional)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      run: |
        if [ ! -z "${{ secrets.NUGET_API_KEY }}" ]; then
          dotnet nuget push ./artifacts/nuget/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
          echo "? Published to NuGet.org"
        else
          echo "?? NUGET_API_KEY not set, skipping NuGet.org publish"
        fi
    
    - name: Upload artifacts to workflow
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.get_version.outputs.VERSION }}
        path: |
          ./artifacts/nuget/*.nupkg
          ./artifacts/*.zip
        retention-days: 90
